# 大运计算逻辑

## 一、概述

大运是八字命理中重要的时间参数，代表人生不同阶段的运势走向。大运计算包含两个核心部分：
1. **起运时间**：何时开始行第一步大运
2. **大运干支**：每步大运的天干地支

---

## 二、起运时间计算

### 2.1 顺逆判断

根据**年干阴阳**和**性别**决定顺逆：

| 年干 | 性别 | 方向 |
|------|------|------|
| 阳干（甲丙戊庚壬） | 男 | 顺行 |
| 阳干（甲丙戊庚壬） | 女 | 逆行 |
| 阴干（乙丁己辛癸） | 男 | 逆行 |
| 阴干（乙丁己辛癸） | 女 | 顺行 |

**口诀：阳男阴女顺行，阴男阳女逆行**

### 2.2 计算到节气的天数

- **顺行**：计算从出生日到**下一个节气**的天数
- **逆行**：计算从出生日到**上一个节气**的天数

> 注意：这里的节气是指「节」，不是「气」。
> 每月有两个节气，前一个叫「节」，后一个叫「气」。
> 如立春是节，雨水是气；惊蛰是节，春分是气。

### 2.3 天数折算年龄

**折算规则：3天折1年，1天折4个月**

```
起运年龄 = 天数 ÷ 3（取整）
剩余月数 = (天数 % 3) × 4
```

**示例**：
- 如果到节气有 15 天
- 起运年龄 = 15 ÷ 3 = 5 岁
- 剩余月数 = 0

- 如果到节气有 17 天
- 起运年龄 = 17 ÷ 3 = 5 岁
- 剩余月数 = (17 % 3) × 4 = 2 × 4 = 8 个月
- 即 5 岁 8 个月起运

---

## 三、大运干支计算

### 3.1 起点

大运从**月柱**开始推算。

### 3.2 推算方向

- **顺行**：从月柱往后推（天干地支都往后）
- **逆行**：从月柱往前推（天干地支都往前）

### 3.3 推算方法

每步大运管 **10 年**。

**顺行公式**：
```
第 n 步大运天干索引 = (月干索引 + n) % 10
第 n 步大运地支索引 = (月支索引 + n) % 12
```

**逆行公式**：
```
第 n 步大运天干索引 = (月干索引 - n + 10) % 10
第 n 步大运地支索引 = (月支索引 - n + 12) % 12
```

### 3.4 示例

假设：
- 月柱：**丁亥**（丁=索引3，亥=索引11）
- 年干：乙（阴干）
- 性别：男
- 判断：阴男逆行

**逆行计算**：
| 步数 | 天干计算 | 地支计算 | 大运 |
|------|----------|----------|------|
| 1 | (3-1+10)%10=2 → 丙 | (11-1+12)%12=10 → 戌 | 丙戌 |
| 2 | (3-2+10)%10=1 → 乙 | (11-2+12)%12=9 → 酉 | 乙酉 |
| 3 | (3-3+10)%10=0 → 甲 | (11-3+12)%12=8 → 申 | 甲申 |
| 4 | (3-4+10)%10=9 → 癸 | (11-4+12)%12=7 → 未 | 癸未 |
| ... | ... | ... | ... |

---

## 四、代码实现

### 4.1 核心代码位置

`src/utils/sizhu.ts`

### 4.2 关键函数

```typescript
// 计算起运信息
function calculateQiyunInfo(
  birthDate: Date,
  gender: 'male' | 'female',
  yearTian: string
): QiyunInfo

// 计算大运
export function calculateDayun(
  birthDate: Date,
  gender: 'male' | 'female',
  monthGanzhi: { tian: string; di: string },
  yearTian: string
): DayunInfo[]
```

---

## 五、注意事项

1. **节气精确性**：起运时间的准确性依赖于节气时间的精确计算
2. **10步大运**：当前代码计算 10 步大运，可根据需要调整
3. **每步10年**：每步大运管辖 10 年，从起运年龄开始累加

---

## 六、数据结构

```typescript
// 大运信息
interface DayunInfo {
  age: number;      // 第几步大运
  ganzhi: string;   // 干支（如"丙戌"）
  tian: string;     // 天干
  di: string;       // 地支
  startAge: number; // 开始年龄
  endAge: number;   // 结束年龄
}

// 起运信息
interface QiyunInfo {
  years: number;       // 起运年龄（年）
  months: number;      // 剩余月数
  days: number;        // 剩余天数
  totalDays: number;   // 到节气的总天数
  isShunxing: boolean; // 是否顺行
  description: string; // 描述文字
}
```

